\subsubsection{WorkPackage 4: User Interfaces}
%Explain, task per task, the work carried out in WP during the reporting period giving details of the work carried out by each beneficiary involved.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Overview}

The objective of WorkPackage 4 is to provide modern, robust, and flexible user interfaces for
computation, supporting real-time sharing, integration with collaborative problem-solving,
multilingual documents, paper writing and publication, links to databases, etc. This work is focused primarily around the \Jupyter project, in the form of:

\begin{itemize}
    \item Enhancing existing \Jupyter tools (\localtaskref{UI}{notebook-collab})
    \item Building new tools in the \Jupyter ecosystem (\localtaskref{UI}{notebook-verification}, \localtaskref{UI}{notebook-collab}, \localtaskref{UI}{vis3d})
    \item Improving the use of \ODK components in \Jupyter and \Sage environments (\localtaskref{UI}{ipython-kernels}, \localtaskref{UI}{sage-sphinx}, \localtaskref{UI}{dynamic-inspect}, \localtaskref{UI}{pari-python})
    \item Demonstrating effectiveness of WorkPackage 4 results in specific scientific applications (\localtaskref{UI}{cfd-vis}, \localtaskref{UI}{oommf-py-ipython-attributes}, \localtaskref{UI}{oommf-nb-ve}, \localtaskref{UI}{oommf-tutorial-and-documentation})
    \item Work on Active Documents, which have some goals in common with \Jupyter notebooks (\localtaskref{UI}{structdocs}, \localtaskref{UI}{mathhub})
\end{itemize}

All deliverables for WorkPackage 4 have been delivered and highly successful in previous reporting periods.
There are no new deliverables in Reporting Period 3.
However, the work of software is never really complete.
Work has continued on some tasks to further improve,
mature, and maintain the results of WorkPackage 4
toward sustainability and to best serve \ODK objectives
based on feedback from \ODK and the wider user community.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subparagraph{Milestones}

\subparagraph{\longmilestoneref{UI-vre}}

\emph{“The prototype VRE shall be extended with improved ease of deployment, new
  functionality such as interactive 3D visualization and real-time
  collaboration, enabling researchers to collaborate productively in a shared
  computational environment. Finally, integrating notebooks and semantic
  knowledge into a publication / knowledge system enable a continuous process
  of leveraging \ODK components from research to publication.”}


The \Jupyter-based prototype for this has been previously delivered in \longmilestoneref{UI-vre-prototype},
and is extended in \longtaskref{UI}{notebook-collab} to more mature functionality.

WorkPackage 4 has resulted in a number of useful pieces of software
for mathematical researchers,
sometimes creating new software,
improving existing software,
or establishing new or improved connections between two existing systems.

Combining the above, Milestone~\longmilestoneref{UI-vre} has
been reached:
from the obtained toolkit, we can produce a \Jupyter-based VRE,
integrating \ODK components.
The Jupyter kernels delivered in \localtaskref{UI}{ipython-kernels}
enable access to a broader collection of mathematical software.
The interactive utility of software such as \Pari is improved in \localtaskref{UI}{pari-python},
and general interactivity and exploration of mathematical objects in \Sage is improved in \localtaskref{UI}{dynamic-inspect}.
The scope of what classes of work can be made interactive is increased
by the development of interactive three-dimensional visualization tools in \localtaskref{UI}{vis3d}.
Further, the process of collaboration on notebook documents is improved by \localtaskref{UI}{notebook-collab}
and prototype support for live collaboration with \localtaskref{UI}{notebook-collab}.
By focusing on \Jupyter as our User Interface of choice,
all of these tools can be combined in a single VRE,
hosted in the cloud or and made accessible to any researcher,
building on the Docker images created in \longdelivref{component-architecture}{virtual-machines}.

The work in this final reporting period has focused on stabilising and maturing the software delivered in previous periods.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Tasks}

\subparagraph{\longtaskref{UI}{ipython-kernels}}
\label{UI@ipython-kernels}

All deliverables for this task have been delivered in previous reporting periods.

Kernels for \ODK components \GAP, \Pari, \Sage, and \Singular,
had been delivered in the form of \delivref{UI}{ipython-kernels-basic}
in RP1 and \longdelivref{UI}{ipython-kernels} in RP2.
Work has continued to develop these kernels in this reporting period
to bring them to further maturity and sustainability.

\smallskip
\subparagraph{\longtaskref{UI}{notebook-collab}}
\label{UI@notebook-collab}

All deliverables for this task have been delivered in previous reporting periods.

Prototype components and plan for \delivref{UI}{jupyter-live-collab} had been delivered in RP2.
This has been developed to further complete prototypes of real-time collaboration in JupyterLab in collaboration with the \Jupyter community.
We are optimistic about its completion and adoption in JupyterLab in the near future.
Real-time collaboration has proven to be the largest and most challenging
effort in WP4,
both in terms of technical effort and in community engagement.
The reason being that real-time collaboration needs extensive work
in development in the core of JupyterLab itself,
which required collaboration and coordination with the JupyterLab community for assembling plans and implementation,
aligning with other goals of the JupyterLab project,
including development of new features in the phosphorjs framework on with JupyterLab is based,
and a complete refactor of the JupyterLab data model.
This work has involved participation in workshops and meetings,
as well as addition of \ODK team members to the core JupyterLab team.
As of August 2019, real-time collaboration has been implemented in JupyterLab in a \texttt{datastore} branch on the official jupyterlab repository on GitHub,
and is expected to arrive in a public release of JupyterLab soon.

In addition, further releases of \texttt{nbdime} from \delivref{UI}{jupyter-collab} have been made.

This work furthers \ODK objective 5 of promoting sustainable software in math and science.


\smallskip
\subparagraph{\longtaskref{UI}{notebook-verification}}
\label{UI@notebook-verification}

All deliverables for this task have been delivered in previous reporting periods.

\longdelivref{UI}{jupyter-test} was delivered in the form of a new Python package, \texttt{nbval},
which enables testing and verification of existing notebooks via a plugin to the Python testing
framework \textbf{pytest}.
In this reporting period, nbval has received further activity and contributions and new releases.
nbval integrates with nbdime from \delivref{UI}{jupyter-collab} to deliver
testable, reproducible notebooks via traditional software development testing practices.
This work furthers \ODK objective 5 of promoting sustainable software in math and science.

\smallskip
\subparagraph{\longtaskref{UI}{sage-sphinx}}
\label{UI@sage-sphinx}

%%% Updated for RP3 by Jeroen Demeyer %%%
Even though this reporting period contains no explicit deliverables
for this task, significant foundation work was carried out which we
now describe. Documentation tools such as Sphinx rely on introspection
to harvest the documentation out the sources. For performance, a large
fraction of the SageMath sources is however written in Cython
(compiled Python) which, until recently, had an incompatible and
limited introspection API. This forced SageMath and other projects to
maintain bespoke and fragile Sphinx extensions to harvest their
documentation.

Tackling this required to dig deep into the system and design,
implement, and get accepted a change to Python itself: PEP (Python
Enhancement Proposal) 590. PEP 590 makes available Python's fast
calling protocol to custom code, thereby enabling full support for
introspection and documentation to Python functions implemented in C
-- e.g. Cython functions --, with no performance loss. This has been
implemented in the upcoming Python~3.8 and Cython~3.0 releases. We
expect not only Cython and therefore SageMath to benefit from this,
but also other similar projects such as Pythran or Numba.

\smallskip
\subparagraph{\longtaskref{UI}{dynamic-inspect}} Due M36 (\delivref{UI}{ipython-advanced-interacts})
\label{UI@dynamic-inspect}

All deliverables for this task have been delivered in previous reporting periods.

As planned in \delivref{UI}{ipython-advanced-interacts}, \ODK
packages \emph{Sage-Combinat-Widgets} and \emph{Sage-Explorer} were
further developed during RP3.
%
%In versions 0.5.0 to 0.7.6,
\emph{Sage-Combinat-Widgets} has gained in
flexibility and has been applied to a range of new mathematical
objects. User interfaces features like feedback have been enhanced,
and documentation has been augmented and gained a tutorial.
%
%With version 0.5.0,
\emph{Sage-Explorer} has gone through a complete new design and reengineering process,
at the same time for better modularity in the code and for better ergonomics.
%
Finally, the \emph{Francy} Jupyter-based graph visualisation library
was generalized to support \Python -- and therefore \SageMath -- in
addition to \GAP.
%
All three benefited from feedback, if not contributions, from end-users.

% Both build on the robust
% foundation of Jupyter Widgets, and explore what it can bring to
% interactive mathematics. The former focuses on interactive
% visualization and edition of mathematical objects, taking
% combinatorics and discrete math as use case. The latter, which uses
% the former as building block, provides rich, detailed, and efficient
% interactive exploration of objects, their properties and
% interrelations. Both are
% \href{https://github.com/sagemath/sage-explorer}{demonstrated online}
% via the Binder service.


\smallskip
\subparagraph{\longtaskref{UI}{structdocs}}
\label{UI@structdocs}

All deliverables for this task have been delivered in previous reporting periods.

Active structured documents are a common need with many use cases, and has many potential
solutions.  Requirements and venues for collaborations were explored through discussions
between participants, in particular at the occasion of
\href{https://wiki.sagemath.org/days77/}{Sage Days 77} workshop (see the
\href{https://wiki.sagemath.org/days77/live-structured-documents}{notes}), and the ODK
meeting in Bremen. The findings were reported in \longdelivref{UI}{adstex}.

In \longdelivref{UI}{adcomp}, We have presented a general framework for in-situ computation in active documents. This is
a contribution towards using mathematical documents -- the traditional form mathematicians
interact with mathematical knowledge and computations -- as a user interface for a
mathematical virtual research environments. This is also a step towards integrating the
two main UI frameworks under investigation in the \ODK project: \Jupyter notebooks and
active documents -- see~\longdelivref{UI}{adstex} -- at a conceptual level. The system is
prototypical at the moment, but can already be embedded into active documents via a
Javascript framework and is ready for use in the \ODK project. The user interface and \SCSCP
connections are quite fresh and need substantial testing and optimizations.

\ODK hosted a workshop on live structured documents in October 2017,
which resulted in the development of \href{https://github.com/minrk/thebelab}{thebelab} software for interactive computing on any website,
enabling interactivity in traditional web-based documentation,
and further development of the \MathHub facilities for evaluation in structured documents.

We developed a JupyterLab extension dedicated to teaching computerscience languages,
such as Python or Sage. JupyterLabTraining (\href{https://gitlab.com/logilab/jupyterhub-training})
is an extension that provides an environment where learners can autonomously do a
series of exercises in order to learn a new programming language. Each exercise is
an independant Jupyter notebook containing the questions, a cell where the learner will
write her code, a hidden cell containing automated tests, and a button to run these tests
and check the code that has been written answers the questions. The left panel shows
the list of all the exercises; they can be sorted by topic (keyword), complexity or
learning track. Thanks to this environment, each learner can do the exercises at his
own pace and choose the exercises that focus on his own points of interest. The
learning process is thus much more efficient for each person.


\subparagraph{\longtaskref{UI}{mathhub}}
\label{UI@mathhub}

All deliverables for this task have been delivered in previous reporting periods.

One of the most prominent features of a virtual research environment (VRE) is a unified user interface. The \ODK approach is to create a mathematical VRE by integrating various pre-existing mathematical software systems. There are two approaches that can serve as a basis for the \ODK UI: computational notebooks and active documents. The former allows for mathematical text around the computation cells of a read-eval-print loop of a mathematical software system and the latter makes semantically annotated documents active.

\MathHub is a portal for active mathematical documents ranging from formal libraries of theorem provers to informal – but rigorous – mathematical documents lightly marked up by preserving LaTeX markup.

As the authoring, maintenance, and curation of theory-structured mathematical ontologies and the transfer of mathematical knowledge via active documents are an important part of the \ODK VRE toolkit, the editing facilities in \MathHub play a great role for the project,
as delivered in \longdelivref{UI}{mathhub-editing}.

\subparagraph{\longtaskref{UI}{vis3d}}
\label{UI@vis3d}

All deliverables for this task have been delivered in previous reporting periods.

The software developed for this task has been delivered in earlier reporting periods.
Packages such as ipyvolume and k3d-jupyter have received further development,
improved compatibility with JupyterLab,
and developed toward maturity and stability,
with growing community adoption.
Several contributions have been made to JupyterLab and
the \Jupyter ecosystem to further support similar work,
benefiting a wide user community.

\subparagraph{\longtaskref{UI}{cfd-vis}} % M12-36
\label{UI@cfd-vis}

No work to report in this period.


\subparagraph{\longtaskref{UI}{Sage-display}} % M24, no deliverables

No work to report in this period.

\subparagraph{\longtaskref{UI}{oommf-py-ipython-attributes}} % M13-19
\label{UI@oommf-py-ipython-attributes}

\ednote{@fangohr: proofread/update report on T4.11: micromagnetics VRE case study}

The micromagnetic virtual research environment is hosted in the
\Jupyter Notebook. The computational backend is the existing \OOMMF
(Object Oriented MicroMagnetic Framework) simulation tool, which is
accessible through the new Python interface that has been created as
part of \ODK
(\localtaskref{component-architecture}{oommf-python-interface}). The
\Jupyter Notebook allows us to integrate the micromagnetic model
specification, the execution of the simulation, and the postprocessing
and data representation within a single executable document; providing
a new computational research environment for micromagnetic simulation
that uses the most widely used simulation code. We have enhanced this
environment further by exploiting that the notebook allows objects to
represent themselves in different ways within the notebook. For
example, Python objects that represent mathematical equations in the
micromagnetic VRE appear rendered as \LaTeX{} in the notebook. It
allows users to interactively compose and explore computational
models, and to be able to inspect what they have put together in the
language of the scientist (i.e. through equations) rather than through
the language of the computer (i.e. code). The addition of this
representation options does not stop the code from being valid \Python
that can be run outside the notebook. We have also provided a
graphical representation of the mesh and discretisation cell as the
appropriate representation of a finite difference mesh to further
assist the effective communication between code and science user and
graphical representation of vector field objects.  We have used
dissemination workshops to seek feedback from users and to refine
interface.

\subparagraph{\longtaskref{UI}{pari-python}}
\label{UI@pari-python}

\ednote{@jdemeyer, @videlec: proofread/update report on T4.12: Pari bindings}

There has been a great deal of progress delivering improved \Pari.
This work has resulted in benefits to the wider Python and \Sage communities
via substantial contributions to the \Sage codebase,
the benefits of which go well beyond this deliverable,
being used by projects outside \ODK.

The end results of this first state of the work are the packages
\href{https://github.com/sagemath/cysignals}{cysignals} and
\href{https://github.com/defeo/cypari2}{CyPari2}, both installable
in a pure \Python environment via the standard tool
\texttt{pip}. Starting from version 8.0, installation via \texttt{pip}
is \Sage's default way of providing the \Pari interface.

\longdelivref{UI}{pari-python-lib2} has been delivered, further improving the \Pari packages
by adding new features, in particular to the Python interface to \Pari.
\emph{cypari2} has gained the ability produce high-resolution SVG plots.
It now also supports the dynamic array type from PARI/GP, \verb/t_LIST/.
The source code of cypari2 is automatically generated.
This automatic generation has been greatly improved
and can be re-used outside cypari2 for any Python package that wants to interface efficiently with PARI.
The cypari2 documentation is also greatly improved,
as a direct result of improvements to the Sphinx documentation system
in \localtaskref{UI}{sage-sphinx}.

\subparagraph{\longtaskref{UI}{oommf-tutorial-and-documentation}
  has been merged into
  \longlocaltaskref{dissem}{dissemination-of-oommf-nb-virtual-environment}
}
\label{UI@oommf-tutorial-and-documentation}

\subparagraph{\longtaskref{UI}{oommf-nb-ve}
  has been merged into
  \longlocaltaskref{dissem}{dissemination-of-oommf-nb-virtual-environment}
}
\label{UI@oommf-nb-ve}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "report"
%%% End:

%  LocalWords:  subsubsection Jupyter taskref notebook-collab ipython-kernels cfd-vis
%  LocalWords:  oommf-py-ipython-attributes oommf-nb-ve oommf-tutorial-and-documentation
%  LocalWords:  mathhub longmilestoneref emph visualization longdelivref UI-vre delivref
%  LocalWords:  jupyter-live-collab ipython-kernel-sage jupyter-collab texttt nbdime
%  LocalWords:  nbval textbf pytest Cython-generated ipython-advanced-interacts adstex
%  LocalWords:  adcomp optimizations thebelab ipyvolume pythreejs threejs ipyscales unray
%  LocalWords:  ipydatawidgets micromagnetic oommf-python-interface cysignals cypari2
%  LocalWords:  dissem dissemination-of-oommf-nb-virtual-environment
