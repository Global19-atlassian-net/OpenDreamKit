\subsubsection{WorkPackage 4: User Interfaces}
%Explain, task per task, the work carried out in WP during the reporting period giving details of the work carried out by each beneficiary involved.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Overview}

The objective of WorkPackage 4 is to provide modern, robust, and flexible user interfaces for
computation, supporting real-time sharing, integration with collaborative problem-solving,
multilingual documents, paper writing and publication, links to databases, etc. This work is focused primarily around the \Jupyter project, in the form of:

\begin{itemize}
    \item Enhancing existing \Jupyter tools (\taskref{UI}{notebook-collab})
    \item Building new tools in the \Jupyter ecosystem (\taskref{UI}{notebook-verification}, \taskref{UI}{notebook-collab}, \taskref{UI}{vis3d})
    \item Improving the use of \ODK components in \Jupyter and \Sage environments (\taskref{UI}{ipython-kernels}, \taskref{UI}{sage-sphinx}, \taskref{UI}{dynamic-inspect}, \taskref{UI}{pari-python})
    \item Demonstrating effectiveness of WorkPackage 4 results in specific scientific applications (\taskref{UI}{cfd-vis}, \taskref{UI}{oommf-py-ipython-attributes}, \taskref{UI}{oommf-nb-ve}, \taskref{UI}{oommf-tutorial-and-documentation})
    \item Work on Active Documents, which have some goals in common with \Jupyter notebooks (\taskref{UI}{structdocs}, \taskref{UI}{mathhub})
\end{itemize}

Progress across WorkPackage 4 has been highly successful thus far.
Several new software packages have been created,
and existing projects in the \Sage and \Jupyter communities have been improved toward sustainability to serve \ODK objectives.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Milestones}

\subparagraph{\longmilestoneref{UI-vre-prototype}}

\emph{“User story: a group of mathematical researchers with access to
  common computational resources, such as a shared lab computer or
  cloud servers, shall be able to deploy a prototype VRE with
  \JupyterHub, integrating \ODK components.
  The Jupyter kernels for mathematical software developed as part of \ODK
  make computational mathematical components accessible in a \Jupyter
  environment, enabling a Jupyter-based deployment of the relevant
  tools for the researchers.
  The process of working on notebooks is greatly improved by review tools
  developed as part of WP4,
  enabling researchers to collaborate to some degree
  in a shared computational environment.”}

WorkPackage 4 has resulted in a number of useful pieces of software
for mathematical researchers,
sometimes creating new software,
improving existing software,
or establishing new or improved connections between two existing systems.

Combining the above, Milestone~\longmilestoneref{UI-vre-prototype} has
been reached:
from the obtained toolkit, we can produce a \Jupyter-based prototype VRE,
integrating \ODK components.
The Jupyter kernels delivered in \taskref{UI}{ipython-kernels}
enable access to a broader collection of mathematical software.
The interactive utility of software such as \Pari is improved in \taskref{UI}{pari-python},
and general interactivity and exploration of mathematical objects in \Sage is improved in \taskref{UI}{dynamic-inspect}.
The scope of what classes of work can be made interactive is increased
by the development of interactive three-dimensional visualization tools in \taskref{UI}{vis3d}.
Further, the process of collaboration on notebook documents is improved by \taskref{UI}{notebook-collab}.
By focusing on \Jupyter as our User Interface of choice,
all of these tools can be combined in a single VRE,
hosted in the cloud or and made accessible to any researcher,
building on the Docker images created in \longdelivref{component-architecture}{virtual-machines}.


\subparagraph{\longmilestoneref{UI-vre}}

\emph{“The prototype VRE shall be extended with improved ease of deployment, new
  functionality such as interactive 3D visualization and real-time
  collaboration, enabling researchers to collaborate productively in a shared
  computational environment. Finally, integrating notebooks and semantic
  knowledge into a publication / knowledge system enable a continuous process
  of leveraging \ODK components from research to publication.”}

\TODO{Brief self-assessment about ODK going to achieve that milestone}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{Tasks}

\subparagraph{\longtaskref{UI}{ipython-kernels}}
\label{UI@ipython-kernels}

\TODO{Clarify what was achieved in Reporting Period 1 and 2 (in the
  following tasks as well).}

The first task for this workpackage is to enable the use of \Jupyter
as uniform notebook interface for the relevant computational
components. \delivref{UI}{ipython-kernels-basic} has been delivered,
providing basic \Jupyter kernels for \GAP, \Pari, \Sage, and
\Singular.
After the basic implementations of these kernels,
they have been developed toward stability and maturity,
as part of delivering \longdelivref{UI}{ipython-kernels}.

\longdelivref{UI}{ipython-kernel-sage} has been delivered, further
enhancing \Sage's \Jupyter integration and preparing for the
systematic transition from the legacy custom-built \Sage notebook
application to \Jupyter in the coming months. Beside all the benefits
of a uniform and actively developed interface for the user,
outsourcing the maintenance of this key but non disciplinary component
will save the \Sage community much needed resources and is an
important step toward the sustainability of the \ODK ecosystem
(Objective 5).

Progress was particularly fast thanks to a very active involvement of
the \Sage community.

\subparagraph{\longtaskref{UI}{notebook-collab}}

\longdelivref{UI}{jupyter-collab} has been delivered in the form of a new \Jupyter package, nbdime,
enabling easier collaboration on notebooks via version control systems such as Git. This project
was presented at the major Scientific Python conferences SciPy US in July 2016 and EuroSciPy in August 2016,
and has been met with enthusiasm from the scientific Python community for its prospect of solving a
longstanding difficulty in working with notebooks.

The \JupyterHub package has received significant updates and further development, specifically a
\emph{Services extension point}, which enables shared workspaces for collaboration, a step on the path
toward real-time collaboration for \delivref{UI}{jupyter-live-collab}.
Prototypes and design for \delivref{UI}{jupyter-live-collab} have been delivered,
with a plan for full production implementation in collaboration with the \Jupyter community during the next year.

\subparagraph{\longtaskref{UI}{notebook-verification}}

\longdelivref{UI}{jupyter-test} has been delivered in the form of a new Python package, nbval,
which enables testing and verification of existing notebooks via a plugin to the Python testing
framework pytest. nbval integrates with nbdime from \delivref{UI}{jupyter-collab} to deliver
testable, reproducible notebooks via traditional software development testing practices.
This work furthers \ODK objective 5 of promoting sustainable software in math and science.

\subparagraph{\longtaskref{UI}{sage-sphinx}}
\label{UI@sage-sphinx}

\Sage has a vast documentation; maintaining and further fostering high
quality requires strong documentation tools.

All along the first two reporting periods, a great deal of work has
invested toward the maintainability of the \Sage documentation build
system, including improving reproducibility of builds, updating
contents, and increasing reliance on community-standard tools instead
of less maintainable bespoke implementations. This included
significant upstream contributions to the Sphinx documentation system
has been significantly improved, especially for Cython-generated
packages, such as those in \taskref{UI}{pari-python}. The current state
and future plans for the last year are described in details in
\longdelivref{UI}{sage-sphinx}.

\subparagraph{\longtaskref{UI}{dynamic-inspect}} Due M36 (\delivref{UI}{ipython-advanced-interacts})

\longdelivref{UI}{ipython-advanced-interacts} was delivered in the
form of two new packages developed by \ODK \emph{Sage Combinat
  Widgets} and \emph{Sage Explorer}. Both build on the robust
foundation of Jupyter Widgets, and explore what it can bring to
interactive mathematics. The former focuses on interactive
visualization and edition of mathematical objects, taking
combinatorics and discrete math as use case. The latter, which uses
the former as building block, provides rich, detailed, and efficient
interactive exploration of objects, their properties and
interrelations. Both are
\href{https://github.com/sagemath/sage-explorer}{demonstrated online}
via the Binder service.

\subparagraph{\longtaskref{UI}{structdocs}}

Active structured documents are a common need with many use cases, and has many potential solutions.
Requirements and venues for collaborations were explored through discussions between participants,
in particular at the occasion of \href{https://wiki.sagemath.org/days77/}{Sage Days 77} workshop
(see the \href{https://wiki.sagemath.org/days77/live-structured-documents}{notes}), and June's ODK
meeting in Bremen. The findings were reported in \longdelivref{UI}{adstex}.

In \longdelivref{UI}{adcomp}, We have presented a general framework for in-situ computation in active documents. This is
a contribution towards using mathematical documents -- the traditional form mathematicians
interact with mathematical knowledge and computations -- as a user interface for a
mathematical virtual research environments. This is also a step towards integrating the
two main UI frameworks under investigation in the \ODK project: \Jupyter notebooks and
active documents -- see~\delivref{UI}{adstex} -- at a conceptual level. The system is
prototypical at the moment, but can already be embedded into active documents via a
Javascript framework and is ready for use in the \ODK project. The user interface and \SCSCP
connections are quite fresh and need substantial testing and optimizations.

\TODO{Update w.r.t. the Live Structured Document workshop}

\subparagraph{\longtaskref{UI}{mathhub}}

One of the most prominent features of a virtual research environment (VRE) is a unified user interface. The \ODK approach is to create a mathematical VRE by integrating various pre-existing mathematical software systems. There are two approaches that can serve as a basis for the \ODK UI: computational notebooks and active documents. The former allows for mathematical text around the computation cells of a real-eval-print loop of a mathematical software system and the latter makes semantically annotated documents active.

\MathHub is a portal for active mathematical documents ranging from formal libraries of theorem provers to informal – but rigorous – mathematical documents lightly marked up by preserving LaTeX markup.

As the authoring, maintenance, and curation of theory-structured mathematical ontologies and the transfer of mathematical knowledge via active documents are an important part of the \ODK VRE toolkit, the editing facilities in \MathHub play a great role for the project,
as delivered in \longdelivref{UI}{mathhub-editing}.

\subparagraph{\longtaskref{UI}{vis3d}}

The current landscape for 3D visualization in Jupyter has been explored and reported on,
in order to identify where \ODK can best contribute to 3D visualization in the notebook, towards \longdelivref{UI}{vis3d}. There have been many community-led developments in this area, including the ipyvolume and K3D packages, and \ODK will further enhance existing community tools to best serve the needs of the community. In particular, developing tools for unstructured mesh visualization and CFD simulations. The SciViJS tool for interactive visualization in a webbrowser has been developed, and has gained better support for use in \Jupyter, also as part of \delivref{UI}{vis3d}.
Following initial investigations, \ODK has contributed to many core projects in the \Jupyter widgets and visualization ecosystems. Including to the core JupyterLab and jupyter-widgets projects,
as well as the \emph{pythreejs} package for exposing the \emph{threejs} javascript library to Python kernels.
Additionally, we have created new packages as building blocks for visualization tools,
including \emph{ipyscales} and \emph{ipydatawidgets}.
We have also produced new visualization tools in the form of \emph{unray} for visualising unstructured mesh data
(e.g. 3D biological or mechanical systems).

\subparagraph{\longtaskref{UI}{cfd-vis}} % M12-36

The tools in \delivref{UI}{vis3d} have been demonstrated as useful in a particular scientific domain,
that of computational fluid dynamics.
The \emph{K3D-Jupyter} project, developed by \ODK, is used to illustrate visualising Lattice-Boltzmann
simulations interactively in a browser without any performance penalty.

\subparagraph{\longtaskref{UI}{Sage-display}} % M24, no deliverables

No work to report in this period.

\subparagraph{\longtaskref{UI}{oommf-py-ipython-attributes}} % M13-19

The micromagnetic virtual research environment is hosted in the \Jupyter
Notebook. The computational engine is the (existing) \OOMMF (Object Oriented
MicroMagnetic Framework) which is accessible through the new Python interface
that has been created as part of \ODK
(\taskref{component-architecture}{oommf-python-interface}). The \Jupyter Notebook allows us to
integrate the problem specification, the execution of the calculation, and the
postprocessing and data representation within a single executable document;
providing a new computational research environment for micromagnetic
simulation that uses the most widely used simulation code. We have enhanced
this environment further by exploiting that the notebook allows objects to
represent themselves in different ways within the notebook. For example,
Python objects that represent mathematical equations in the micromagnetic VRE
appear rendered as \LaTeX{} in the notebook. It allows users to interactively
compose and explore computational models, and to be able to inspect what they
have put together in the language of the scientist (i.e. through equations)
rather than through the language of the computer (i.e. code). The addition of
this representation options does not stop the code from being valid \Python
that can be run outside the notebook. We have also provided a graphical
representation of the mesh and discretisation cell as the appropriate
representation of a finite difference mesh to further assist the effective
communication between code and science user, graphical representation of
vector field objects, and GUI elements for data exploration. We have used dissemination workshops
to seek feedback from users and to refine interface.

\subparagraph{\longtaskref{UI}{pari-python}}
\label{UI@pari-python}

\TODO{Much of the text below is about Reporting Period 1; summarize
  this part in juste 1-2 paragraphs.}

Completing \longdelivref{UI}{pari-python-lib1} happened to be more difficult than
originally planned. The high level of coupling between \Sage internals
and the \Pari interface made it very delicate to pull the latter out
of the \Sage codebase. Initially planned to be delivered in month 6,
it was completed in month 16.

The process of making this deliverable possible led to a great amount
of refactoring inside the \Sage project.
The benefits go beyond this deliverable:
implementations of \href{https://github.com/videlec/pplpy}{PPL}
and \href{https://github.com/fplll/fpylll}{fpLLL}
Python interfaces indirectly relied on this work.

As summarized in
\href{http://trac.sagemath.org/ticket/20238}{Trac ticket 20238},
it required close to 50 \emph{tickets}, which fell in the
following categories:

\begin{itemize}
\tightlist
\item Moving \Sage's C interrupts and signals API to a separate \Python/\Cython
  package called
  \href{https://github.com/sagemath/cysignals}{cysignals}.
\item Decoupling \Sage's \Pari interface from the \emph{coercion
    model}.
\item Upgrading the \Pari interface to the latest upstream version
  (2.9.2).
\item Cleaning up the \Pari interface API, by removing unneeded object
  orientation and external dependencies.
\item Moving the \Pari interface to a separate \Python/\Cython package
  \href{https://github.com/defeo/cypari2}{CyPari2}, depending
  on cysignals.
\end{itemize}

The end results of this work are the packages
\href{https://github.com/sagemath/cysignals}{cysignals} and
\href{https://github.com/defeo/cypari2}{CyPari2}, both installable
in a pure \Python environment via the standard tool
\texttt{pip}. Starting from version 8.0, installation via \texttt{pip}
is \Sage's default way of providing the \Pari interface.

\longdelivref{UI}{pari-python-lib2} has been delivered, further improving the \Pari packages
by adding new features, in particular to the Python interface to \Pari.
\emph{cypari2} has gained the ability produce high-resolution SVG plots.
It now also supports the dynamic array type from PARI/GP, \verb/t_LIST/.
The source code of cypari2 is automatically generated.
This automatic generation has been greatly improved
and can be re-used outside cypari2 for any Python package that wants to interface efficiently with PARI.
The cypari2 documentation is also greatly improved,
as a direct result of improvements to the Sphinx documentation system
in \taskref{UI}{sage-sphinx}.

\subparagraph{\longtaskref{UI}{oommf-tutorial-and-documentation}
  has been merged into
  \longtaskref{dissem}{dissemination-of-oommf-nb-virtual-environment}
}

\subparagraph{\longtaskref{UI}{oommf-nb-ve}
  has been merged into
  \longtaskref{dissem}{dissemination-of-oommf-nb-virtual-environment}
}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "report"
%%% End:
